<!DOCTYPE html>
<html>
<head>
    <title>Test Fetch Fixes</title>
    <style>
        .test-pass { color: green; }
        .test-fail { color: red; }
    </style>
</head>
<body>
    <h1>Test Microdata.fetch Fixes</h1>
    <div id="results"></div>
    
    <script type="module">
        import { Microdata } from '../index.mjs';
        
        const results = document.getElementById('results');
        
        // Mock fetch
        window.fetch = async (url) => {
            return {
                ok: true,
                text: async () => `
                    <html>
                    <body>
                        <div id="test1" itemscope itemtype="https://schema.org/Person">
                            <span itemprop="name">Test Person</span>
                        </div>
                    </body>
                    </html>
                `
            };
        };
        
        async function runTests() {
            try {
                // Test 1: Basic fetch
                const doc = await Microdata.fetch('http://example.com/test.html');
                results.innerHTML += `<div class="test-pass">✓ Basic fetch works</div>`;
                results.innerHTML += `<div>- Doc has getElementById: ${typeof doc.getElementById === 'function'}</div>`;
                results.innerHTML += `<div>- Doc has querySelector: ${typeof doc.querySelector === 'function'}</div>`;
                results.innerHTML += `<div>- Doc has querySelectorAll: ${typeof doc.querySelectorAll === 'function'}</div>`;
                
                // Test 2: getElementById with microdata
                const element = doc.getElementById('test1');
                if (element && element.microdata && element.microdata.name === 'Test Person') {
                    results.innerHTML += `<div class="test-pass">✓ getElementById returns element with microdata</div>`;
                } else {
                    results.innerHTML += `<div class="test-fail">✗ getElementById microdata issue</div>`;
                }
                
                // Test 3: Fragment fetch
                const fragmentEl = await Microdata.fetch('http://example.com/test.html#test1');
                results.innerHTML += `<div class="test-pass">✓ Fragment fetch works</div>`;
                results.innerHTML += `<div>- Element id: ${fragmentEl.id}</div>`;
                results.innerHTML += `<div>- Has querySelector: ${typeof fragmentEl.querySelector === 'function'}</div>`;
                results.innerHTML += `<div>- Microdata name: ${fragmentEl.microdata?.name}</div>`;
                results.innerHTML += `<div>- Microdata @id: ${fragmentEl.microdata?.['@id']}</div>`;
                
            } catch (e) {
                results.innerHTML += `<div class="test-fail">✗ Error: ${e.message}</div>`;
                console.error(e);
            }
        }
        
        runTests();
    </script>
</body>
</html>