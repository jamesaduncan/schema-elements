<!DOCTYPE html>
<html>
<head>
    <title>Test Validation Fix</title>
    <style>
        .test-pass { color: green; }
        .test-fail { color: red; }
    </style>
</head>
<body>
    <h1>Test Schema Validation Fix</h1>
    
    <!-- Test element with missing required property -->
    <div id="credential1" itemscope itemtype="https://rustybeam.net/schema/Credential">
        <span itemprop="username">testuser</span>
        <!-- Missing password property -->
    </div>
    
    <div id="results"></div>
    
    <script type="module">
        import { Schema, RustyBeamNetSchema } from '../index.mjs';
        
        const results = document.getElementById('results');
        let eventFired = false;
        
        // Listen for validation event
        document.addEventListener('DOMSchemaInvalidData', (e) => {
            eventFired = true;
            results.innerHTML += '<div class="test-pass">✓ DOMSchemaInvalidData event fired</div>';
            results.innerHTML += `<div>- Property: ${e.detail.property}</div>`;
            results.innerHTML += `<div>- Type: ${e.detail.type}</div>`;
            results.innerHTML += `<div>- Expected: ${e.detail.expected}</div>`;
            results.innerHTML += `<div>- Actual: ${e.detail.actual}</div>`;
        });
        
        // Create schema
        const schema = new RustyBeamNetSchema('https://rustybeam.net/schema/Credential', {
            '@type': 'Schema',
            '@context': 'https://rustybeam.net/schema/',
            'username': {
                '@type': 'Property',
                'name': 'username',
                'type': 'https://rustybeam.net/schema/Text',
                'cardinality': '1'
            },
            'password': {
                '@type': 'Property',
                'name': 'password',
                'type': 'https://rustybeam.net/schema/Text',
                'cardinality': '1'  // Required
            }
        });
        schema.loaded = true;
        
        results.innerHTML += '<div>Schema created with properties:</div>';
        results.innerHTML += `<div>- Properties: ${JSON.stringify(Object.keys(schema.properties))}</div>`;
        
        // Cache the schema
        Schema.cache(schema);
        results.innerHTML += '<div class="test-pass">✓ Schema cached</div>';
        
        // Get element and validate
        const element = document.getElementById('credential1');
        const item = element.microdata;
        
        results.innerHTML += '<div>Validating element...</div>';
        const validationResult = item.validate();
        
        if (validationResult === false) {
            results.innerHTML += '<div class="test-pass">✓ Validation correctly failed</div>';
        } else {
            results.innerHTML += '<div class="test-fail">✗ Validation should have failed</div>';
        }
        
        setTimeout(() => {
            if (!eventFired) {
                results.innerHTML += '<div class="test-fail">✗ DOMSchemaInvalidData event not fired</div>';
            }
        }, 100);
    </script>
</body>
</html>